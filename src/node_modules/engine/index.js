import {Container} from 'pixi.js';
import * as display from './display';
import raf from 'raf';
import * as resources from './resources';

let animationHandle = 0;
let container = null;

export function launch({ init, update, stage } = {}) {
  if (typeof init !== 'function') {
    throw new Error('Param "init" must be a function');
  }
  if (typeof update !== 'function') {
    throw new Error('Param "update" must be a function');
  }
  if (!(stage instanceof Container)) {
    throw new Error('Param "stage" must inherit from PIXI.Container');
  }
  container = stage;
  const tasks = [display.init(), resources.init()];
  return Promise.all(tasks).then(() => {
    init();
    let lastTime;
    const renderer = display.renderer;
    const draw = (time) => {
      const delta = (time - lastTime)/1000;
      lastTime = time;
      update(delta);
      renderer.render(container);
      animationHandle = raf(draw);
    };
    animationHandle = raf((time) => {
      lastTime = time;
      draw(time);
    });
  });
}

export function exit() {
  container.removeChildren();
  raf.cancel(animationHandle);
  animationHandle = 0;
  const tasks = [display.destroy(), resources.destroy()];
  return Promise.all(tasks);
}
