/* eslint no-console: 'off' */
import {Atlas} from 'texture-atlas';
import axios from 'axios';
import {BaseTexture, Rectangle, Texture, utils} from 'pixi.js';
import {textureMap} from 'shared/config';

export const rawCache = Object.create(null);
export const baseTextureCache = utils.BaseTextureCache;
export const textureCache = utils.TextureCache;

export function destroy() {
  for (const key in textureCache) {
    textureCache[key].destroy();
    delete textureCache[key];
  }
  for (const key in baseTextureCache) {
    baseTextureCache[key].destroy();
    delete baseTextureCache[key];
  }
  for (const key in rawCache) {
    delete rawCache[key];
  }
}

export function init(pack = true) {
  return new Promise((resolve, reject) => {
    axios.get(textureMap)
      .then((response) => new Promise((resolveImages, _rejectImages) => {
        const map = response.data;
        const imgs = Object.create(null);
        let texturesLeft = Object.keys(map).length;
        for (const key in map) {
          const url = map[key];
          const img = document.createElement('img');
          img.addEventListener('load', () => {
            console.info(`Loaded texture "${key}" from URL "${url}"`);
            imgs[key] = img;
            texturesLeft -= 1;
            if (!texturesLeft) {
              resolveImages(imgs);
            }
          }, { once: true });
          img.addEventListener('error', () => {
            console.error(`Failed to load texture "${key}" from URL "${url}":`);
          }, { once: true });
          img.src = url;
        }
      }))
      .then((imgs) => {
        if (pack) {
          const canvas = document.createElement('canvas');
          const atlas = new Atlas(canvas);
          for (const key in imgs) {
            const img = imgs[key];
            atlas.expand(key, img);
          }
          const base = new BaseTexture(canvas);
          const uvs = atlas.uv();
          const atlasWidth = canvas.width;
          const atlasHeight = canvas.height;
          for (const key in imgs) {
            const uv = uvs[key];
            const uvTopLeft = uv[0];
            const uvBottomRight = uv[2];
            const [uvX, uvY] = uvTopLeft;
            const uvWidth = uvBottomRight[0] - uvX;
            const uvHeight = uvBottomRight[1] - uvY;
            const frame = new Rectangle(
              uvX * atlasWidth,
              uvY * atlasHeight,
              uvWidth * atlasWidth,
              uvHeight * atlasHeight);
            const texture = new Texture(base, frame);
            Texture.addTextureToCache(texture, key);
          }
        } else {
          for (const key in imgs) {
            const url = imgs[key].src;
            const texture = Texture.from(url);
            Texture.removeTextureFromCache(url);
            Texture.addTextureToCache(texture, key);
          }
        }
        resolve();
      })
      .catch((err) => {
        reject(err);
      });
  });
}
